#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
 
 // 1. Стандартная проверка на загрузку
 Если ОбменДанными.Загрузка Тогда
  Возврат;
 КонецЕсли;
 
 // 2. Пытаемся назначить исполнителя, если его нет (Логика из рабочего кода)
 Если ЭтоНовый() Или Исполнитель.Пустая() Тогда
  НазначитьИсполнителяАвтоматически();
 КонецЕсли;
 
 // 3. УПРАВЛЕНИЕ СТАТУСАМИ
 ИмяТекущегоСтатуса = СокрЛП(Статус.Наименование);
 
 // Проверяем: если документ уже в финальных стадиях, не меняем статус автоматически
 Если ИмяТекущегоСтатуса <> "Решено" И ИмяТекущегоСтатуса <> "Закрыто" 
  И ИмяТекущегоСтатуса <> "В работе" И ИмяТекущегоСтатуса <> "Возврат в работу" Тогда
  
  Если Исполнитель.Пустая() Тогда
   // Исполнителя нет — ставим статус "Новое"
   СтатусНовое = Справочники.СтатусыОбращений.НайтиПоНаименованию("Новое");
   Если Не СтатусНовое.Пустая() Тогда Статус = СтатусНовое; КонецЕсли;
  Иначе
   // Исполнитель ЕСТЬ. Ставим "Назначено", если он был "Новое" или пустой
   Если ИмяТекущегоСтатуса = "Новое" Или Статус.Пустая() Тогда
    СтатусНазначено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
    Если Не СтатусНазначено.Пустая() Тогда Статус = СтатусНазначено; КонецЕсли;
   КонецЕсли;
  КонецЕсли;
 КонецЕсли;

 // 4. РАСЧЕТ SLA И ПРОСРОЧКИ
 СтатусНазначено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
 Если ЗначениеЗаполнено(Сервис) И ЗначениеЗаполнено(Приоритет) И Статус = СтатусНазначено Тогда
  
  СтруктСЛА = СерверСервисДеск.РассчитатьSLA(Сервис, Приоритет);
  ЭтотОбъект.СрокРеакции = СтруктСЛА.СрокРеакции;
  
  // Сразу вычисляем просрочку
  Если ЗначениеЗаполнено(ЭтотОбъект.СрокРеакции) Тогда
   ЭтотОбъект.Просрочено = (ТекущаяДата() > ЭтотОбъект.СрокРеакции);
  КонецЕсли;
 КонецЕсли;

 // 5. ПОДГОТОВКА ДАННЫХ ДЛЯ ИСТОРИИ (Сравнение старого и нового)
 Если НЕ ЭтоНовый() Тогда
  // Получаем "старые" данные напрямую из базы для сравнения
  СтарыеДанные = Ссылка.ПолучитьОбъект();
  
  // Сравниваем Статус
  Если Статус <> СтарыеДанные.Статус Тогда
   ДополнительныеСвойства.Вставить("Изменение_Статус", Истина);
   ДополнительныеСвойства.Вставить("Старый_Статус", СтарыеДанные.Статус);
  КонецЕсли;
  
  // Сравниваем Исполнителя
  Если Исполнитель <> СтарыеДанные.Исполнитель Тогда
   ДополнительныеСвойства.Вставить("Изменение_Исполнитель", Истина);
   ДополнительныеСвойства.Вставить("Старый_Исполнитель", СтарыеДанные.Исполнитель);
  КонецЕсли;
  
  // Сравниваем Приоритет
  Если Приоритет <> СтарыеДанные.Приоритет Тогда
   ДополнительныеСвойства.Вставить("Изменение_Приоритет", Истина);
   ДополнительныеСвойства.Вставить("Старый_Приоритет", СтарыеДанные.Приоритет);
  КонецЕсли;
 Иначе
  // Для нового документа просто пометим, что это создание
  ДополнительныеСвойства.Вставить("ЭтоНовыйДокумент", Истина);
 КонецЕсли;

КонецПроцедуры


Процедура ПриЗаписи(Отказ)
 
 Если ОбменДанными.Загрузка Тогда
  Возврат;
 КонецЕсли;
 // ------------------

 // 1. Создание
 Если ДополнительныеСвойства.Свойство("ЭтоНовыйДокумент") Тогда
  ЗаписатьВИсторию("Создание", "-", "Новое обращение");
 КонецЕсли;
 
 // 2. Смена статуса
 Если ДополнительныеСвойства.Свойство("Изменение_Статус") Тогда
  ЗаписатьВИсторию("Смена статуса", ДополнительныеСвойства.Старый_Статус, Статус);
 КонецЕсли;
 
 // 3. Смена исполнителя
 Если ДополнительныеСвойства.Свойство("Изменение_Исполнитель") Тогда
  ЗаписатьВИсторию("Смена исполнителя", ДополнительныеСвойства.Старый_Исполнитель, Исполнитель);
 КонецЕсли;
 
 // 4. Смена приоритета
 Если ДополнительныеСвойства.Свойство("Изменение_Приоритет") Тогда
  ЗаписатьВИсторию("Смена приоритета", ДополнительныеСвойства.Старый_Приоритет, Приоритет);
 КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ЗаписатьВИсторию(ТипИзменения, ЗначениеСтарое, ЗначениеНовое)
 
 МЗ = РегистрыСведений.ИсторияИзмененийОбращений.СоздатьМенеджерЗаписи();
 
 МЗ.Период    = ТекущаяДата();
 МЗ.Обращение = Ссылка;
 
 МЗ.ТипИзменения       = ТипИзменения;
 МЗ.ПредыдущееЗначение = Строка(ЗначениеСтарое);
 МЗ.НовоеЗначение      =Строка(ЗначениеНовое);
 
 // Определение пользователя
 ИмяПользователяИБ = ИмяПользователя();
 МЗ.Пользователь = Справочники.ПользователиИТ.НайтиПоНаименованию(ИмяПользователяИБ);
 
 Попытка
  МЗ.Записать();
 Исключение
  // Ошибка записи истории не должна прерывать работу документа
 КонецПопытки;
 
КонецПроцедуры

Процедура НазначитьИсполнителяАвтоматически()
 
 // 1. Проверяем группу
 Если ГруппаИсполнителей.Пустая() И ЗначениеЗаполнено(Сервис) Тогда
  ГруппаИсполнителей = Сервис.ГруппаИсполнителей; 
 КонецЕсли;
 
 Если ГруппаИсполнителей.Пустая() Тогда Возврат; КонецЕсли;
 
 СтатусРешено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Решено");
 СтатусЗакрыто = Справочники.СтатусыОбращений.НайтиПоНаименованию("Закрыто");
 
 Если СтатусРешено.Пустая() Тогда СтатусРешено = Справочники.СтатусыОбращений.ПустаяСсылка(); КонецЕсли;
 Если СтатусЗакрыто.Пустая() Тогда СтатусЗакрыто = Справочники.СтатусыОбращений.ПустаяСсылка(); КонецЕсли;

 // 2. Запрос на поиск наименее загруженного сотрудника
 ТекстЗапроса = 
 "ВЫБРАТЬ ПЕРВЫЕ 1
 | Исполнители.Ссылка КАК ИсполнительСсылка
 |ИЗ
 | Справочник.Исполнители КАК Исполнители
 |  ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОбращениеПользователя КАК Обращения
 |  ПО Исполнители.Ссылка = Обращения.Исполнитель
 |   И (Обращения.Статус <> &СтатусРешено И Обращения.Статус <> &СтатусЗакрыто)
 |ГДЕ
 | Исполнители.Группа = &ГруппаОтбора
 | И Исполнители.ПометкаУдаления = ЛОЖЬ
 | И Исполнители.Наименование <> """"
 |СГРУППИРОВАТЬ ПО
 | Исполнители.Ссылка
 |УПОРЯДОЧИТЬ ПО
 | КОЛИЧЕСТВО(Обращения.Ссылка) ВОЗР";
 
 Запрос = Новый Запрос(ТекстЗапроса);
 Запрос.УстановитьПараметр("ГруппаОтбора", ГруппаИсполнителей);
 Запрос.УстановитьПараметр("СтатусРешено", СтатусРешено);
 Запрос.УстановитьПараметр("СтатусЗакрыто", СтатусЗакрыто);
 
 Результат = Запрос.Выполнить();
 
 Если Не Результат.Пустой() Тогда
  Выборка = Результат.Выбрать();
  Выборка.Следующий();
  ЭтотОбъект.Исполнитель = Выборка.ИсполнительСсылка;
  Сообщить("УСПЕХ! Назначен исполнитель: " + ЭтотОбъект.Исполнитель);
 Иначе
  Сообщить("Автоназначение: Не найдено сотрудников в группе " + ГруппаИсполнителей);
 КонецЕсли;
 
КонецПроцедуры

#КонецОбласти