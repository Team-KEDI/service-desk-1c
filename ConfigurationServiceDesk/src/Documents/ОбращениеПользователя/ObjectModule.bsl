#Область ОбработчикиСобытий

Процедура ПередЗаписью(Отказ, РежимЗаписи, РежимПроведения)
	
	// 1. Стандартная проверка на загрузку
	Если ОбменДанными.Загрузка Тогда
		Возврат;
	КонецЕсли;
	
	// 2. Пытаемся назначить исполнителя, если его нет
	// Это заполнит поле "Исполнитель", если сработает ваш алгоритм поиска
	Если ЭтоНовый() Или Исполнитель.Пустая() Тогда
		НазначитьИсполнителяАвтоматически();
	КонецЕсли;
	
	// 3. Управление статусами
	// Получаем текущее имя статуса для проверок (убираем лишние пробелы)
	ИмяТекущегоСтатуса = СокрЛП(Статус.Наименование);
	
	// Проверяем: если документ уже "Решено" или "Закрыто", мы его вообще не трогаем
	Если ИмяТекущегоСтатуса <> "Решено" И ИмяТекущегоСтатуса <> "Закрыто" Тогда
		
		Если Исполнитель.Пустая() Тогда
			
			// Исполнителя нет — ставим статус "Новое"
			СтатусНовое = Справочники.СтатусыОбращений.НайтиПоНаименованию("Новое");
			Если Не СтатусНовое.Пустая() Тогда
				Статус = СтатусНовое;
			КонецЕсли;
			
		Иначе
			
			// Исполнитель ЕСТЬ. 
			// Но меняем статус на "Назначено" только если сейчас он "Новое" или не заполнен.
			// Это нужно, чтобы не "откатить" статус, если работа уже "В процессе".
			Если ИмяТекущегоСтатуса = "Новое" Или Статус.Пустая() Тогда
				
				СтатусНазначено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
				Если Не СтатусНазначено.Пустая() Тогда
					Статус = СтатусНазначено;
				КонецЕсли;
				
			КонецЕсли;
			
		КонецЕсли;
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура НазначитьИсполнителяАвтоматически()
	
	// 1. Проверяем группу в документе
	Если ГруппаИсполнителей.Пустая() И ЗначениеЗаполнено(Сервис) Тогда
		ГруппаИсполнителей = Сервис.ГруппаИсполнителей; 
	КонецЕсли;
	
	Если ГруппаИсполнителей.Пустая() Тогда
		Возврат; // Нет группы - нет смысла искать
	КонецЕсли;
	
	// 2. Ищем статусы. УБЕДИСЬ, что в справочнике они называются ТОЧНО так
	СтатусРешено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Решено");
	СтатусЗакрыто = Справочники.СтатусыОбращений.НайтиПоНаименованию("Закрыто");
	
	// Если вдруг не нашли, создадим пустые ссылки нужного типа, чтобы запрос не выдавал ошибку по параметрам
	Если СтатусРешено.Пустая() Тогда СтатусРешено = Справочники.СтатусыОбращений.ПустаяСсылка(); КонецЕсли;
	Если СтатусЗакрыто.Пустая() Тогда СтатусЗакрыто = Справочники.СтатусыОбращений.ПустаяСсылка(); КонецЕсли;

	// 3. Запрос по справочнику ИСПОЛНИТЕЛИ
	ТекстЗапроса = 
	"ВЫБРАТЬ ПЕРВЫЕ 1
	|	Исполнители.Ссылка КАК ИсполнительСсылка
	|ИЗ
	|	Справочник.Исполнители КАК Исполнители
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ОбращениеПользователя КАК Обращения
	|		ПО Исполнители.Ссылка = Обращения.Исполнитель
	|			И (Обращения.Статус <> &СтатусРешено И Обращения.Статус <> &СтатусЗакрыто)
	|ГДЕ
	|	Исполнители.Группа = &ГруппаОтбора
	|	И Исполнители.ПометкаУдаления = ЛОЖЬ
	|	И Исполнители.Наименование <> """"
	|СГРУППИРОВАТЬ ПО
	|	Исполнители.Ссылка
	|УПОРЯДОЧИТЬ ПО
	|	КОЛИЧЕСТВО(Обращения.Ссылка) ВОЗР";
	
	Запрос = Новый Запрос(ТекстЗапроса);
	Запрос.УстановитьПараметр("ГруппаОтбора", ГруппаИсполнителей);
	Запрос.УстановитьПараметр("СтатусРешено", СтатусРешено);
	Запрос.УстановитьПараметр("СтатусЗакрыто", СтатусЗакрыто);
	
	Результат = Запрос.Выполнить();
	
	Если Не Результат.Пустой() Тогда
		Выборка = Результат.Выбрать();
		Выборка.Следующий();
		
		// Назначаем реквизиту документа
		ЭтотОбъект.Исполнитель = Выборка.ИсполнительСсылка;
		Сообщить("УСПЕХ! Назначен: " + ЭтотОбъект.Исполнитель);
	Иначе
		Сообщить("Автоназначение: Не найдено сотрудников в группе " + ГруппаИсполнителей);
	КонецЕсли;
	
КонецПроцедуры
#КонецОбласти