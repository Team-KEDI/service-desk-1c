#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    // 1. Заполнение данных для нового документа
    Если Объект.Ссылка.Пустая() Тогда
        ЗаполнитьПользователяПоНаименованию();
        
        СистемнаяИнфо = Новый СистемнаяИнформация;
        Объект.ВерсияПлатформы = СистемнаяИнфо.ВерсияПриложения;
        Объект.Конфигурация = Метаданные.Имя;
        Объект.ИмяБазы = СтрокаСоединенияИнформационнойБазы();
    КонецЕсли;
    
    // 2. Управление доступом по ролям
    ЭтоАдминистратор = РольДоступна("Администратор");
    ДоступРазрешен   = ЭтоАдминистратор ИЛИ РольДоступна("Исполнитель");
    
    Элементы.Исполнитель.ТолькоПросмотр = НЕ ЭтоАдминистратор;
    
    // Управление технической группой
    Если Элементы.Найти("ГруппаТехническиеДанные") <> Неопределено Тогда
        Элементы.ГруппаТехническиеДанные.Видимость = ДоступРазрешен;
        Элементы.ГруппаТехническиеДанные.ТолькоПросмотр = Истина;
    КонецЕсли;

    // 3. Установка начальной видимости кнопок
    УстановитьВидимостьКнопок();

    // 4. НАСТРОЙКА ФИЛЬТРА ИСТОРИИ (чтобы видеть историю только этого документа)
    // Добавляем отбор в динамический список "ИсторияИзменений"
    ЭлементОтбора = ИсторияИзменений.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
    ЭлементОтбора.ЛевоеЗначение  = Новый ПолеКомпоновкиДанных("Обращение");
    ЭлементОтбора.ВидСравнения   = ВидСравненияКомпоновкиДанных.Равно;
    ЭлементОтбора.ПравоеЗначение = Объект.Ссылка;
    ЭлементОтбора.Использование  = Истина;
    
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
    // Вызывается при открытии существующего документа или перелистывании
    УстановитьВидимостьКнопок();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВРаботу(Команда)
 
 Если Объект.Исполнитель.Пустая() Тогда
  Сообщить("Сначала нужно назначить исполнителя!");
  Возврат;
 КонецЕсли;
 
 ВРаботуНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура Решено(Команда)
    
 РешеноНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура ПринятьРешение(Команда)
    
 ПринятьРешениеНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура ОтклонитьРешение(Команда)
    
 ОтклонитьРешениеНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВидимостьКнопок()
    
    // Получаем ссылки на статусы из справочника
    СтатусНазначено       = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
    СтатусВРаботе         = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
    СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
    СтатусВозвратВРаботу  = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
    
    ТекущийСтатус = Объект.Статус;
    
    // УПРАВЛЕНИЕ ВИДИМОСТЬЮ КНОПОК
    
    Элементы.ФормаВРаботу.Видимость = (ТекущийСтатус = СтатусНазначено ИЛИ ТекущийСтатус = СтатусВозвратВРаботу);
    Элементы.ФормаРешено.Видимость = (ТекущийСтатус = СтатусВРаботе);
    
    ВидныКнопкиПринятия = (ТекущийСтатус = СтатусНаПодтверждении);
    Элементы.ФормаПринятьРешение.Видимость   = ВидныКнопкиПринятия;
    Элементы.ФормаОтклонитьРешение.Видимость = ВидныКнопкиПринятия;

КонецПроцедуры

&НаСервере
Процедура ВРаботуНаСервере()
 
 Если Объект.Ссылка.Пустая() Тогда
  ЭтотОбъект.Записать(); 
 КонецЕсли;
 
 СтатусНазначено      = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
 СтатусВРаботе        = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
 СтатусВозвратВРаботу = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
 
 Если Объект.Статус = СтатусНазначено ИЛИ Объект.Статус = СтатусВозвратВРаботу Тогда
  
  ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
  ДокументОбъект.Статус = СтатусВРаботе;
  
  Если Объект.Статус = СтатусНазначено И ЗначениеЗаполнено(Объект.Сервис) И ЗначениеЗаполнено(Объект.Приоритет) Тогда
   СтруктСЛА = СерверСервисДеск.РассчитатьSLA(Объект.Сервис, Объект.Приоритет);
   ДокументОбъект.СрокРешения = СтруктСЛА.СрокРешения;
  КонецЕсли;
  Объект.ДатаПринятияВРаботу = ТекущаяДата();
  Попытка
   ДокументОбъект.Записать();
   ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
   УстановитьВидимостьКнопок();
   Сообщить("Статус обновлен: В работе");
  Исключение
   Сообщить("Ошибка при записи: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура РешеноНаСервере()
 
 СтатусВРаботе         = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 
 Если Объект.Статус = СтатусВРаботе Тогда
  
  ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
  ДокументОбъект.Статус = СтатусНаПодтверждении;
  
  Попытка
   ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
   ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
   УстановитьВидимостьКнопок();
   Сообщить("Статус обновлен: На подтверждении");
  Исключение
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ПринятьРешениеНаСервере()
 
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 СтатусРешено          = Справочники.СтатусыОбращений.НайтиПоНаименованию("Решено");
 
 Если Объект.Статус = СтатусНаПодтверждении Тогда
  Объект.Статус = СтатусРешено;
  Объект.ДатаЗакрытия = ТекущаяДата();
  Попытка
   ЭтотОбъект.Записать();
   УстановитьВидимостьКнопок();
   Сообщить("Обращение успешно решено и закрыто.");
  Исключение
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ОтклонитьРешениеНаСервере()
 
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 СтатусВозвратВРаботу  = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
 
 Если Объект.Статус = СтатусНаПодтверждении Тогда
  Объект.Статус = СтатусВозвратВРаботу;
  Попытка
   ЭтотОбъект.Записать();
   УстановитьВидимостьКнопок();
   Сообщить("Решение отклонено. Обращение возвращено в работу.");
  Исключение
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПользователяПоНаименованию()
 ИмяТекущегоПользователя = ПользователиИнформационнойБазы.ТекущийПользователь().ПолноеИмя;
 Если ПустаяСтрока(ИмяТекущегоПользователя) Тогда
  ИмяТекущегоПользователя = ИмяПользователя();
 КонецЕсли;
 НайденныйПользователь = Справочники.ПользователиИТ.НайтиПоНаименованию(ИмяТекущегоПользователя);
 Если Не НайденныйПользователь.Пустая() Тогда
  Если НайденныйПользователь.Активен Тогда
   Объект.Пользователь = НайденныйПользователь;
  КонецЕсли;
 КонецЕсли;
КонецПроцедуры

#КонецОбласти