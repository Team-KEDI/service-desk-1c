#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    // 1. Заполнение данных для нового документа
    Если Объект.Ссылка.Пустая() Тогда
        ЗаполнитьПользователяПоНаименованию();
        
        СистемнаяИнфо = Новый СистемнаяИнформация;
        Объект.ВерсияПлатформы = СистемнаяИнфо.ВерсияПриложения;
        Объект.Конфигурация = Метаданные.Имя;
        Объект.ИмяБазы = СтрокаСоединенияИнформационнойБазы();
    КонецЕсли;
    
    // 2. Управление доступом по ролям
    ЭтоАдминистратор = РольДоступна("Администратор");
    ДоступРазрешен   = ЭтоАдминистратор ИЛИ РольДоступна("Исполнитель");
    
    Элементы.Исполнитель.ТолькоПросмотр = НЕ ЭтоАдминистратор;
    
    // Управление технической группой
    Если Элементы.Найти("ГруппаТехническиеДанные") <> Неопределено Тогда
        Элементы.ГруппаТехническиеДанные.Видимость = ДоступРазрешен;
        Элементы.ГруппаТехническиеДанные.ТолькоПросмотр = Истина;
    КонецЕсли;

    // 3. Установка начальной видимости кнопок
    УстановитьВидимостьКнопок();
    
КонецПроцедуры

&НаСервере
Процедура ПриЧтенииНаСервере(ТекущийОбъект)
    // Вызывается при открытии существующего документа или перелистывании
    УстановитьВидимостьКнопок();
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ВРаботу(Команда)
 
 Если Объект.Исполнитель.Пустая() Тогда
  Сообщить("Сначала нужно назначить исполнителя!");
  Возврат;
 КонецЕсли;
 
 ВРаботуНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура Решено(Команда)
    
 РешеноНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура ПринятьРешение(Команда)
    
 ПринятьРешениеНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

&НаКлиенте
Процедура ОтклонитьРешение(Команда)
    
 ОтклонитьРешениеНаСервере();
 ОповеститьОбИзменении(Объект.Ссылка);
    
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьВидимостьКнопок()
    
    // Получаем ссылки на статусы из справочника
    СтатусНазначено       = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
    СтатусВРаботе         = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
    СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
    СтатусВозвратВРаботу  = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
    
    ТекущийСтатус = Объект.Статус;
    
    // УПРАВЛЕНИЕ ВИДИМОСТЬЮ КНОПОК
    
    // 1. Кнопка "В работу" (видна, если статус Назначено или Возврат в работу)
    Элементы.ФормаВРаботу.Видимость = (ТекущийСтатус = СтатусНазначено ИЛИ ТекущийСтатус = СтатусВозвратВРаботу);
    
    // 2. Кнопка "Решено" (видна только когда статус "В работе")
    Элементы.ФормаРешено.Видимость = (ТекущийСтатус = СтатусВРаботе);
    
    // 3. Кнопки "Принять" и "Отклонить" (видны только на этапе подтверждения)
    ВидныКнопкиПринятия = (ТекущийСтатус = СтатусНаПодтверждении);
    Элементы.ФормаПринятьРешение.Видимость   = ВидныКнопкиПринятия;
    Элементы.ФормаОтклонитьРешение.Видимость = ВидныКнопкиПринятия;

КонецПроцедуры

&НаСервере
Процедура ВРаботуНаСервере()
 
 // Если документ новый - записываем, чтобы получить ссылку
 Если Объект.Ссылка.Пустая() Тогда
  ЭтотОбъект.Записать(); 
 КонецЕсли;
 
 СтатусНазначено      = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
 СтатусВРаботе        = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
 СтатусВозвратВРаботу = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
 
 // Проверяем возможность перехода
 Если Объект.Статус = СтатусНазначено ИЛИ Объект.Статус = СтатусВозвратВРаботу Тогда
  
  ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
  ДокументОбъект.Статус = СтатусВРаботе;
  
  // Расчет SLA (если это первый переход из Назначено)
  Если Объект.Статус = СтатусНазначено И ЗначениеЗаполнено(Объект.Сервис) И ЗначениеЗаполнено(Объект.Приоритет) Тогда
   СтруктСЛА = СерверСервисДеск.РассчитатьSLA(Объект.Сервис, Объект.Приоритет);
   ДокументОбъект.СрокРешения = СтруктСЛА.СрокРешения;
  КонецЕсли;
  
  Попытка
   ДокументОбъект.Записать();
   ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
   УстановитьВидимостьКнопок();
   Сообщить("Статус обновлен: В работе");
  Исключение
   Сообщить("Ошибка при записи: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура РешеноНаСервере()
 
 СтатусВРаботе         = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 
 Если Объект.Статус = СтатусВРаботе Тогда
  
  // 1. Получаем объект документа из базы
  ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
  ДокументОбъект.Статус = СтатусНаПодтверждении;
  
  Попытка
   // 2. ЯВНО указываем режим записи - "Запись", а не "Проведение".
   // Это позволяет менять реквизиты проведенного документа без его перепроведения.
   ДокументОбъект.Записать(РежимЗаписиДокумента.Запись);
   
   // 3. Обновляем данные на форме, чтобы статус изменился на экране
   ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
   
   УстановитьВидимостьКнопок();
   Сообщить("Статус обновлен: На подтверждении");
  Исключение
   // Если прав всё равно не хватает даже на простую запись:
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ПринятьРешениеНаСервере()
 
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 СтатусРешено          = Справочники.СтатусыОбращений.НайтиПоНаименованию("Решено");
 
 Если Объект.Статус = СтатусНаПодтверждении Тогда
  
  Объект.Статус = СтатусРешено;
  
  Попытка
   ЭтотОбъект.Записать();
   УстановитьВидимостьКнопок();
   Сообщить("Обращение успешно решено и закрыто.");
  Исключение
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ОтклонитьРешениеНаСервере()
 
 СтатусНаПодтверждении = Справочники.СтатусыОбращений.НайтиПоНаименованию("На подтверждении");
 СтатусВозвратВРаботу  = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");
 
 Если Объект.Статус = СтатусНаПодтверждении Тогда
  
  Объект.Статус = СтатусВозвратВРаботу;
  
  Попытка
   ЭтотОбъект.Записать();
   УстановитьВидимостьКнопок();
   Сообщить("Решение отклонено. Обращение возвращено в работу.");
  Исключение
   Сообщить("Ошибка: " + ОписаниеОшибки());
  КонецПопытки;
  
 КонецЕсли;
 
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьПользователяПоНаименованию()
 
 ИмяТекущегоПользователя = ПользователиИнформационнойБазы.ТекущийПользователь().ПолноеИмя;
 
 Если ПустаяСтрока(ИмяТекущегоПользователя) Тогда
  ИмяТекущегоПользователя = ИмяПользователя();
 КонецЕсли;
 
 НайденныйПользователь = Справочники.ПользователиИТ.НайтиПоНаименованию(ИмяТекущегоПользователя);
 
 Если Не НайденныйПользователь.Пустая() Тогда
  Если НайденныйПользователь.Активен Тогда
   Объект.Пользователь = НайденныйПользователь;
  КонецЕсли;
 КонецЕсли;

КонецПроцедуры

#КонецОбласти