#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
    
    // Проверяем, что это новый документ
    Если Объект.Ссылка.Пустая() Тогда
        ЗаполнитьПользователяПоНаименованию();
    КонецЕсли;
    
    // Проверяем, есть ли у текущего пользователя роль администратора
    ЭтоАдминистратор = РольДоступна("Администратор");
    
    // Управляем доступностью поля "Исполнитель"
    // "Исполнитель" — это имя элемента на форме (проверьте его в свойствах)
    Элементы.Исполнитель.ТолькоПросмотр = НЕ ЭтоАдминистратор;
    
    // Заполняем системную информацию, если это новый документ
    Если Объект.Ссылка.Пустая() Тогда
        
        // 1. Версия платформы
        СистемнаяИнфо = Новый СистемнаяИнформация;
        Объект.ВерсияПлатформы = СистемнаяИнфо.ВерсияПриложения; // Например, 8.3.27.1508
        
        // 2. Имя конфигурации
        Объект.Конфигурация = Метаданные.Имя; // ConfigurationServiceDesk
        
        // 3. Строка соединения (Имя базы)
        Объект.ИмяБазы = СтрокаСоединенияИнформационнойБазы();
        
    КонецЕсли;
    
    // 2. Управление доступом
    // Проверяем наличие прав администратора или исполнителя
    ДоступРазрешен = РольДоступна("Администратор") ИЛИ РольДоступна("Исполнитель");
    
    // Управляем группой, в которую вы объединили эти три поля
    // Если группы нет, можно управлять каждым полем отдельно: Элементы.Конфигурация.Видимость = ...
    
    Элементы.ГруппаТехническиеДанные.Видимость = ДоступРазрешен;
    Элементы.ГруппаТехническиеДанные.ТолькоПросмотр = Истина; // Запрет редактирования для всех

КонецПроцедуры

#КонецОбласти
&НаКлиенте
Процедура Решено(Команда)
	РешеноНаСервере();
	ОповеститьОбИзменении(Объект.Ссылка)
КонецПроцедуры

&НаКлиенте
Процедура ВРаботу(Команда)
	
	// Проверяем, можно ли вообще взять в работу
	Если Объект.Исполнитель.Пустая() Тогда
		Сообщить("Сначала нужно назначить исполнителя!");
		Возврат;
	КонецЕсли;
	
	ВРаботуНаСервере();
	ОповеститьОбИзменении(Объект.Ссылка)
КонецПроцедуры


#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ЗаполнитьПользователяПоНаименованию()
	
	// Получаем полное имя текущего сеанса (например, "Иванов Иван Петрович")
	ИмяТекущегоПользователя = ПользователиИнформационнойБазы.ТекущийПользователь().ПолноеИмя;
	
	// Если полное имя не задано, попробуем краткое имя (логин)
	Если ПустаяСтрока(ИмяТекущегоПользователя) Тогда
		ИмяТекущегоПользователя = ИмяПользователя();
	КонецЕсли;
	
	// Ищем в справочнике ПользователиИТ по Наименованию
	НайденныйПользователь = Справочники.ПользователиИТ.НайтиПоНаименованию(ИмяТекущегоПользователя);
	
	// Проверяем, что объект найден и он активен
	Если Не НайденныйПользователь.Пустая() Тогда
		
		// Если нужно проверять флаг "Активен" (как в вашем реквизите)
		Если НайденныйПользователь.Активен Тогда
			Объект.Пользователь = НайденныйПользователь;
		КонецЕсли;
		
	КонецЕсли;

КонецПроцедуры


&НаСервере
Процедура ВРаботуНаСервере()
	
	Если Объект.Ссылка.Пустая() Тогда
		ЭтотОбъект.Записать(); 
	КонецЕсли;
	
	ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
	
	СтатусВРаботе = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
	
	Если Не СтатусВРаботе.Пустая() Тогда
		ДокументОбъект.Статус = СтатусВРаботе;
		
		Попытка
			ДокументОбъект.Записать();
			ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
			Сообщить("Статус обновлен: В работе");
		Исключение
			Сообщить("Ошибка при записи: " + ОписаниеОшибки());
		КонецПопытки;
	КонецЕсли;
	ДокументОбъект.Записать();
    ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
КонецПроцедуры

&НаСервере
Процедура РешеноНаСервере()
	
	Если Объект.Ссылка.Пустая() Тогда
		ЭтотОбъект.Записать(); 
	КонецЕсли;
	
	ДокументОбъект = Объект.Ссылка.ПолучитьОбъект();
	СтатусВРаботе = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
	СтатусОжиданиеОтвета = Справочники.СтатусыОбращений.НайтиПоНаименованию("Ожидание ответа");
	
	Если Не СтатусОжиданиеОтвета.Пустая() И Объект.Статус = СтатусВРаботе Тогда
		ДокументОбъект.Статус = СтатусОжиданиеОтвета;
		
		Попытка
			ДокументОбъект.Записать();
			// ЧИТАЕМ данные из базы обратно на форму, чтобы статус обновился на экране
			ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
			Сообщить("Статус обновлен: Ожидание ответа");
		Исключение
			Сообщить("Ошибка при записи: " + ОписаниеОшибки());
		КонецПопытки;
	КонецЕсли;
	ДокументОбъект.Записать();
    ЗначениеВРеквизитФормы(ДокументОбъект, "Объект");
КонецПроцедуры
#КонецОбласти