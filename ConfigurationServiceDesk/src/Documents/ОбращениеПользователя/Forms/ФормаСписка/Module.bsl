#Область ОбработчикиСобытийФормы

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	// Основная логика фильтрации списка при открытии
	УстановитьФильтрациюПоРолям();
	
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура УстановитьФильтрациюПоРолям()
	
	// 1. Очищаем все существующие отборы, чтобы они не суммировались при перезапуске
	Список.Отбор.Элементы.Очистить();
	
	// 2. Получаем ссылку на текущего пользователя в справочнике "ПользователиИТ"
	ИмяТекущегоПользователя = ПользователиИнформационнойБазы.ТекущийПользователь().ПолноеИмя;
	Если ПустаяСтрока(ИмяТекущегоПользователя) Тогда
		ИмяТекущегоПользователя = ИмяПользователя(); // Если полное имя не задано, берем логин
	КонецЕсли;
	
	ТекущийПользовательСсылка = Справочники.ПользователиИТ.НайтиПоНаименованию(ИмяТекущегоПользователя);
	
	// 3. Проверка на Администратора (Полные права)
	// Замените "Администратор" на точное имя вашей роли администратора в EDT
	Если РольДоступна("Администратор") Тогда
		Сообщить("Авторизация: Администратор. Доступ ко всем обращениям разрешен.");
		Возврат; // Выходим, отборы не накладываются
	КонецЕсли;

	// 4. Проверка на то, найден ли пользователь в справочнике
	Если ТекущийПользовательСсылка.Пустая() Тогда
		Сообщить("Ошибка: Пользователь '" + ИмяТекущегоПользователя + "' не найден в справочнике 'ПользователиИТ'. Список пуст.");
		// Скрываем все записи в целях безопасности
		ЭлементБлокировки = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементБлокировки.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Ссылка");
		ЭлементБлокировки.ВидСравнения = ВидСравненияКомпоновкиДанных.Ложь;
		Возврат;
	КонецЕсли;

	// 5. РАСПРЕДЕЛЕНИЕ ПО РОЛЯМ
	
	// ПРОВЕРКА РОЛИ ИСПОЛНИТЕЛЯ
	Если РольДоступна("Исполнитель") Тогда 
		
		Сообщить("Авторизация: Исполнитель. Установлен фильтр по личным задачам и группе.");
		
		ГруппаИЛИ = Список.Отбор.Элементы.Добавить(Тип("ГруппаЭлементовОтбораКомпоновкиДанных"));
		ГруппаИЛИ.ТипГруппы = ТипГруппыЭлементовОтбораКомпоновкиДанных.ГруппаИли;
		ГруппаИЛИ.Использование = Истина;
		
		// Условие А: Документы, где текущий пользователь указан как Исполнитель
		ОтборЛичный = ГруппаИЛИ.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ОтборЛичный.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Исполнитель");
		ОтборЛичный.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ОтборЛичный.ПравоеЗначение = ТекущийПользовательСсылка;
		ОтборЛичный.Использование = Истина;
		
		// Условие Б: Документы, назначенные на группу текущего пользователя
		// Проверьте, что имя реквизита в документе именно "Группа"
		Если ЗначениеЗаполнено(ТекущийПользовательСсылка.Группа) Тогда
			ОтборГруппа = ГруппаИЛИ.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
			ОтборГруппа.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Группа"); 
			ОтборГруппа.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
			ОтборГруппа.ПравоеЗначение = ТекущийПользовательСсылка.Группа;
			ОтборГруппа.Использование = Истина;
		КонецЕсли;
		
	// ПРОВЕРКА ОБЫЧНОГО ПОЛЬЗОВАТЕЛЯ (Клиента)
	Иначе 
		
		Сообщить("Авторизация: Пользователь. Доступ только к собственным обращениям.");
		
		ЭлементОтбора = Список.Отбор.Элементы.Добавить(Тип("ЭлементОтбораКомпоновкиДанных"));
		ЭлементОтбора.ЛевоеЗначение = Новый ПолеКомпоновкиДанных("Пользователь");
		ЭлементОтбора.ВидСравнения = ВидСравненияКомпоновкиДанных.Равно;
		ЭлементОтбора.ПравоеЗначение = ТекущийПользовательСсылка;
		ЭлементОтбора.Использование = Истина;
		
		// Запрещаем пользователю менять или отключать этот отбор вручную
		ЭлементОтбора.РежимОтображения = РежимОтображенияЭлементаНастройкиКомпоновкиДанных.Недоступный;
		
	КонецЕсли;

КонецПроцедуры

#КонецОбласти