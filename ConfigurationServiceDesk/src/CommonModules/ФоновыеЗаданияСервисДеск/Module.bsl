Процедура ПроверитьПросрочкуSLA() Экспорт
  
  // 1. Подготовка ссылок на статусы
  СтатусНазначено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
  СтатусНовое     = Справочники.СтатусыОбращений.НайтиПоНаименованию("Новое");
  
  Запрос = Новый Запрос;
  Запрос.Текст = 
    "ВЫБРАТЬ
    |  ОбращениеПользователя.Ссылка КАК Ссылка,
    |  ОбращениеПользователя.Сервис КАК Сервис,
    |  ОбращениеПользователя.Приоритет КАК Приоритет,
    |  ОбращениеПользователя.Дата КАК Дата,
    |  ОбращениеПользователя.Проведен КАК Проведен
    |ИЗ
    |  Документ.ОбращениеПользователя КАК ОбращениеПользователя
    |ГДЕ
    |  ОбращениеПользователя.СрокРеакции < &ТекущаяДата
    |  И (ОбращениеПользователя.Статус = &СтатусНазначено 
    |  ИЛИ ОбращениеПользователя.Статус = &СтатусНовое)";
  
  Запрос.УстановитьПараметр("ТекущаяДата", ТекущаяДата());
  Запрос.УстановитьПараметр("СтатусНазначено", СтатусНазначено);
  Запрос.УстановитьПараметр("СтатусНовое", СтатусНовое);
  
  Результат = Запрос.Выполнить().Выбрать();
  
  Пока Результат.Следующий() Цикл
    
    Объект = Результат.Ссылка.ПолучитьОбъект();
    
    // 2. Получаем настройки сдвига из регистра
    Отбор = Новый Структура("Сервис, Приоритет", Результат.Сервис, Результат.Приоритет);
    Настройки = РегистрыСведений.НастройкиSLA.Получить(Отбор);
    
    // Проверяем, что сдвиг настроен в регистре (не равен 0)
    Если Настройки.СдвигПриоритета > 0 Тогда
      
      // Математика: получаем числовой номер нового приоритета
      ТекущийНомер = Число(Объект.Приоритет.Код);
      НовыйНомер = ТекущийНомер - Настройки.СдвигПриоритета;
      
      // Защита от выхода за границы (P1 - самый высокий)
      Если НовыйНомер < 1 Тогда 
        НовыйНомер = 1; 
      КонецЕсли;
      
      // 3. КОНКАТЕНАЦИЯ: приклеиваем 8 нулей и берем правые 9 знаков
      // Формат(..., "ЧГ=0") убирает невидимый пробел-разделитель тысяч
      СтрокаНомера = Формат(НовыйНомер, "ЧГ=0");
      НовыйКод = Прав("00000000" + СтрокаНомера, 9);
      
      НайденныйПриоритет = Справочники.Приоритеты.НайтиПоКоду(НовыйКод);
      
      Если Не НайденныйПриоритет.Пустая() И Объект.Приоритет <> НайденныйПриоритет Тогда
        
        Объект.Приоритет = НайденныйПриоритет;
        
        // 4. Пересчет сроков SLA под новый приоритет
        Попытка
          СЛА = СерверСервисДеск.РассчитатьSLA(Объект.Сервис, Объект.Приоритет, Объект.Дата);
          Объект.СрокРеакции = СЛА.СрокРеакции;
          Объект.СрокРешения = СЛА.СрокРешения;
        Исключение
          // Если в модуле расчета SLA есть ошибки, запишем хотя бы смену приоритета
        КонецПопытки;
        
        // 5. Запись документа (сохраняем статус Проведен/Нет)
        Если Объект.Проведен Тогда
          Объект.Записать(РежимЗаписиДокумента.Проведение);
        Иначе
          Объект.Записать(РежимЗаписиДокумента.Запись);
        КонецЕсли;
        
        Сообщить("Документ " + Объект.Номер + ": приоритет повышен до " + НайденныйПриоритет.Наименование);
        
      ИначеЕсли НайденныйПриоритет.Пустая() Тогда
        Сообщить("Ошибка: Не найден приоритет с кодом [" + НовыйКод + "]");
      КонецЕсли;
      
    КонецЕсли;
    
  КонецЦикла;
  
КонецПроцедуры