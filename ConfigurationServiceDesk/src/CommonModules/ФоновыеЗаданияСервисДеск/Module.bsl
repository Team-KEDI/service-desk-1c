Процедура ПроверитьПросрочкуSLA() Экспорт
  
  // 1. Получаем статусы (как они есть в базе)
  СтатусНазначено = Справочники.СтатусыОбращений.НайтиПоНаименованию("Назначено");
  СтатусНовое     = Справочники.СтатусыОбращений.НайтиПоНаименованию("Новое");
  СтатусВРаботе   = Справочники.СтатусыОбращений.НайтиПоНаименованию("В работе");
  СтатусВРаботе_М = Справочники.СтатусыОбращений.НайтиПоНаименованию("в работе");
  СтатусВозврат   = Справочники.СтатусыОбращений.НайтиПоНаименованию("Возврат в работу");

  // 2. Упрощенный запрос: берем все необработанные документы в нужных статусах
  Запрос = Новый Запрос;
  Запрос.Текст = 
    "ВЫБРАТЬ
    |  ОбращениеПользователя.Ссылка КАК Ссылка,
    |  ОбращениеПользователя.Номер КАК Номер,
    |  ОбращениеПользователя.Статус КАК Статус,
    |  ОбращениеПользователя.СрокРеакции КАК СрокРеакции,
    |  ОбращениеПользователя.СрокРешения КАК СрокРешения,
    |  ОбращениеПользователя.ПриоритетПовышен КАК ПриоритетПовышен
    |ИЗ
    |  Документ.ОбращениеПользователя КАК ОбращениеПользователя
    |ГДЕ
    |  (ОбращениеПользователя.ПриоритетПовышен = ЛОЖЬ ИЛИ ОбращениеПользователя.ПриоритетПовышен ЕСТЬ NULL)";
  
  Результат = Запрос.Выполнить().Выбрать();
  ТекущаяДата = ТекущаяДата();
  
  Пока Результат.Следующий() Цикл
    
    НужноПовышать = Ложь;
    ТекСтатус = Результат.Статус;
    
    // ЛОГИКА ПРОВЕРКИ 1: Реакция
    Если (ТекСтатус = СтатусНазначено ИЛИ ТекСтатус = СтатусНовое) Тогда
      Если Результат.СрокРеакции < ТекущаяДата И ЗначениеЗаполнено(Результат.СрокРеакции) Тогда
        НужноПовышать = Истина;
      КонецЕсли;
    
    // ЛОГИКА ПРОВЕРКИ 2: Решение
    ИначеЕсли (ТекСтатус = СтатусВРаботе ИЛИ ТекСтатус = СтатусВРаботе_М ИЛИ ТекСтатус = СтатусВозврат) Тогда
      Если Результат.СрокРешения < ТекущаяДата И ЗначениеЗаполнено(Результат.СрокРешения) Тогда
        НужноПовышать = Истина;
      КонецЕсли;
    КонецЕсли;

    Если НужноПовышать Тогда
      Объект = Результат.Ссылка.ПолучитьОбъект();
      
      // Настройки из регистра
      Отбор = Новый Структура("Сервис, Приоритет", Объект.Сервис, Объект.Приоритет);
      Настройки = РегистрыСведений.НастройкиSLA.Получить(Отбор);
      
      Если Настройки.СдвигПриоритета > 0 Тогда
        
        НовыйНомер = Число(Объект.Приоритет.Код) - Настройки.СдвигПриоритета;
        Если НовыйНомер < 1 Тогда НовыйНомер = 1; КонецЕсли;
        
        НовыйКод = Прав("00000000" + Формат(НовыйНомер, "ЧГ=0"), 9);
        НайденныйПриоритет = Справочники.Приоритеты.НайтиПоКоду(НовыйКод);
        
        Если Не НайденныйПриоритет.Пустая() Тогда
          Объект.Приоритет = НайденныйПриоритет;
          Объект.ПриоритетПовышен = Истина;
          
          // Рассчитываем новые сроки
          Попытка
            СЛА = СерверСервисДеск.РассчитатьSLA(Объект.Сервис, Объект.Приоритет, Объект.Дата);
            Объект.СрокРеакции = СЛА.СрокРеакции;
            Объект.СрокРешения = СЛА.СрокРешения;
          Исключение
          КонецПопытки;
          
          Объект.Записать();
          Сообщить("Документ №" + Результат.Номер + ": Приоритет успешно повышен.");
        КонецЕсли;
      Иначе
        Сообщить("Документ №" + Результат.Номер + ": В регистре настроек Сдвиг = 0.");
      КонецЕсли;
    КонецЕсли;
    
  КонецЦикла;
  
КонецПроцедуры