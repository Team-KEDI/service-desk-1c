#Область ПрограммныйИнтерфейс

// Рассчитывает сроки SLA на основании переданных параметров и настроек регистра.
//
// Параметры:
//  Сервис - СправочникСсылка.СервисыИТ - Выбранный ИТ-сервис.
//  Приоритет - СправочникСсылка.Приоритеты - Приоритет обращения.
//  ДатаНачала - Дата - Дата, от которой ведется расчет.
//  УчитыватьНерабочееВремя - Булево - Флаг использования производственного календаря.
//
// Возвращаемое значение:
//  Структура - содержит поля:
//      * СрокРеакции - Дата - Рассчитанный крайний срок реакции.
//      * СрокРешения - Дата - Рассчитанный крайний срок решения.
//
Функция РассчитатьSLA(Сервис, Приоритет) Экспорт
    
    // Если дата не передана, берем текущую
    БазоваяДата = ТекущаяДата();
    
    Результат = Новый Структура("СрокРеакции, СрокРешения", БазоваяДата, БазоваяДата);
    
    Отбор = Новый Структура("Сервис, Приоритет", Сервис, Приоритет);
    Настройки = РегистрыСведений.НастройкиSLA.Получить(Отбор);
    
    // Если настроек нет, сроки равны дате документа
    Если Настройки.ВремяРеакции = 0 И Настройки.ВремяРешения = 0 Тогда
        Возврат Результат; 
    КонецЕсли;
    
    // Если флаг "Учитывать" выключен в документе, считаем просто по календарю
    Если Не Настройки.УчитыватьНерабочееВремя Тогда
        Результат.СрокРеакции = БазоваяДата + (Настройки.ВремяРеакции * 60);
        Результат.СрокРешения = БазоваяДата + (Настройки.ВремяРешения * 3600);
        Возврат Результат;
    КонецЕсли;
	
	
    // Получаем секунды начала и конца дня из настроек (например, из 01.01.0001 09:00:00 получаем 32400 сек)
    НачалоСек = Настройки.ВремяНачалаРаботы - НачалоДня(Настройки.ВремяНачалаРаботы);
    КонецСек  = Настройки.ВремяЗавершенияРаботы - НачалоДня(Настройки.ВремяЗавершенияРаботы);
    
    // Если админ не заполнил время, ставим по умолчанию 9-18
    НачалоСек = ?(НачалоСек = 0, 9 * 3600, НачалоСек);
    КонецСек  = ?(КонецСек = 0, 18 * 3600, КонецСек);

    Результат.СрокРеакции = ДобавитьРабочееВремя(БазоваяДата, Настройки.ВремяРеакции * 60, НачалоСек, КонецСек);
    Результат.СрокРешения = ДобавитьРабочееВремя(БазоваяДата, Настройки.ВремяРешения * 3600, НачалоСек, КонецСек);
    
    Возврат Результат;
	
	
КонецФункции

// Выполняет проверку превышения срока реакции и эскалацию обращения.
//
// Параметры:
//  ОбращениеСсылка - ДокументСсылка.ОбращениеПользователя - Ссылка на проверяемый документ.
//
// Возвращаемое значение:
//  Булево - Истина, если произошла эскалация; Ложь в противном случае.

Функция ПроверитьПросрочку(ОбращениеСсылка) Экспорт
  
  // Проверяем, что ссылка не пустая
  Если ОбращениеСсылка.Пустая() Тогда
    Возврат Ложь;
  КонецЕсли;
  
  ОбращениеОбъект = ОбращениеСсылка.ПолучитьОбъект();
  СтатусНовое = Справочники.СтатусыОбращений.НайтиПоНаименованию("Новое");
  
  // Проверяем условия для эскалации
  Если ОбращениеОбъект.Статус = СтатусНовое 
    И ЗначениеЗаполнено(ОбращениеОбъект.СрокРеакции) 
    И ТекущаяДата() > ОбращениеОбъект.СрокРеакции Тогда
    
    // 1. Устанавливаем критический приоритет P1
    ПриоритетP1 = Справочники.Приоритеты.НайтиПоНаименованию("P1 Критичный");
    Если Не ПриоритетP1.Пустая() Тогда
      ОбращениеОбъект.Приоритет = ПриоритетP1;
    КонецЕсли;
    
    // 2. Устанавливаем флаг просрочки
    ОбращениеОбъект.Просрочено = Истина;
    
    // 3. Сохраняем изменения
    Попытка
      ОбращениеОбъект.Записать();
      Возврат Истина;
    Исключение
      Возврат Ложь;
    КонецПопытки;
    
  КонецЕсли;
  
  Возврат Ложь;
  
КонецФункции

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

// Добавляет время к дате, пропуская субботы и воскресенья.
//
// Расчетная функция с поддержкой динамического графика
Функция ДобавитьРабочееВремя(ДатаНачала, СекундыДобавления, НачалоДняСек, КонецДняСек)
    
    ТекущаяДатаРасчета = ДатаНачала;
    ОсталосьДобавить = СекундыДобавления;
    
    Пока ОсталосьДобавить > 0 Цикл
        
        ДеньНед = ДеньНедели(ТекущаяДатаРасчета);
        ТекущееВремяСек = ТекущаяДатаРасчета - НачалоДня(ТекущаяДатаРасчета);
        
        // Прыжок через выходные или через ночь
        Если ДеньНед > 5 ИЛИ ТекущееВремяСек >= КонецДняСек Тогда
            ТекущаяДатаРасчета = НачалоДня(ТекущаяДатаРасчета + 86400) + НачалоДняСек;
            Продолжить;
        КонецЕсли;
        
        // Если еще слишком рано (утро до открытия)
        Если ТекущееВремяСек < НачалоДняСек Тогда
            ТекущаяДатаРасчета = НачалоДня(ТекущаяДатаРасчета) + НачалоДняСек;
            Продолжить;
        КонецЕсли;

        ОсталосьДоКонцаДня = КонецДняСек - ТекущееВремяСек;
        ДобавляемСейчас = Мин(ОсталосьДобавить, ОсталосьДоКонцаДня);
        
        ТекущаяДатаРасчета = ТекущаяДатаРасчета + ДобавляемСейчас;
        ОсталосьДобавить = ОсталосьДобавить - ДобавляемСейчас;
        
    КонецЦикла;
    
    Возврат ТекущаяДатаРасчета;
КонецФункции
#КонецОбласти